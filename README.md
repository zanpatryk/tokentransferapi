# TokenTransfer

A GraphQL API for managing wallets and performing atomic token transfers. Built in Go, it supports both in-memory and PostgreSQL-backed storage, and provides a Docker setup for easy deployment and testing.

## Project Overview

- **Language**: Go
- **Frameworks/Libraries**:
  - [gqlgen](https://gqlgen.com/) for schema-driven GraphQL
  - [pgx](https://github.com/jackc/pgx) for PostgreSQL connectivity
  - [golang-migrate](https://github.com/golang-migrate/migrate) for database migrations
  - [godotenv](https://github.com/joho/godotenv) for environment configuration
- **Features**:
  - Create and query wallet balances
  - Atomic token transfers
  - Pluggable storage: in-memory or Postgres
  - GraphQL Playground for interactive testing
  - Dockerized application and testing environment

## Repository Structure

```
tokentransfer/
├── .dockerignore
├── .env               # Environment variables (create from .env.example)
├── .env.example       # Sample configuration
├── Dockerfile         # Build Docker image
├── Dockerfile.test    # Build image for running tests
├── docker-compose.yml       # App + Postgres services
├── docker-compose.test.yml  # Test service with migrations
├── gqlgen.yml         # gqlgen codegen configuration
├── go.mod
├── go.sum
├── README.md
├── main.go            # Application entrypoint
│
├── db/
│   └── migrations/    # SQL migration scripts
│       ├── *_create_wallet_table.up.sql
│       └── *_create_wallet_table.down.sql
│
├── graph/
│   ├── generated/     # Auto-generated by gqlgen
│   ├── resolver.go    # Resolver setup
│   ├── schema.graphqls
│   └── schema.resolvers.go
│
└── store/
    ├── wallet_store.go        # Store interface + in-memory impl
    ├── postgres_store.go      # Postgres implementation
    └── postgres_store_test.go # Integration tests using Postgres
```

## Prerequisites

- [Git](https://git-scm.com/)
- [Docker](https://www.docker.com/)
- [Docker Compose](https://docs.docker.com/compose/)

## Getting Started

1. **Clone the repository**

   ```bash
   git clone https://github.com/zanpatryk/tokentransfer.git
   cd tokentransfer
   ```

2. **Configure environment**

   ```bash
   cp .env.example .env
   # Edit `.env` to set your preferred values:
   # PORT=8080
   # DATABASE_URL=postgres://postgres:password@db:5432/tokentransfer?sslmode=disable
   ```

3. **Start services**

   ```bash
   docker-compose up --build
   ```

   - The GraphQL Playground will be available at `http://localhost:${PORT}/`

## Running Tests

This project includes integration tests that run against a real PostgreSQL instance.

```bash
# Using Docker Compose
docker-compose -f docker-compose.test.yml up --build --abort-on-container-exit

```

## Using the API

### GraphQL Playground

Open your browser and navigate to:

```
http://localhost:${PORT}/
```

### Queries

- **Get a single wallet**

```graphql
query GetWallet($address: ID!) {
  wallet(address: $address) {
    address
    balance
    createdAt
    updatedAt
  }
}
```

- **Get all wallets**

```graphql
query {
  wallets {
    address
    balance
    createdAt
    updatedAt
  }
}
```

### Mutations

- **Transfer tokens**

```graphql
mutation Transfer($from: ID!, $transfers: TransferInput!) {
  transfer(from_address: $from, transfers: $transfers)
}
```

- **TransferInput**:
  ```json
  {
    "to_address": "recipient-address",
    "amount": 100
  }
  ```

### Example Mutation

```graphql
mutation {
  transfer(
    from_address: "0x0000000000000000000000000000000000000001"
    transfers: {
      to_address: "0x0000000000000000000000000000000000000000"
      amount: -3
    }
  )
}
```

This will atomically move 75 tokens from `wallet1` to `wallet2` and `wallet3`, returning the new balance of `wallet1`.

## Default Initial Wallets

By default, when the application starts up (Postgres modes), three wallets are created for you to play with:

| Address                                      | Initial Balance |
| -------------------------------------------- | --------------- |
| `0x0000000000000000000000000000000000000000` | 1000            |
| `0x0000000000000000000000000000000000000001` | 1000            |
| `0x0000000000000000000000000000000000000002` | 1000            |

These are set up in the resolver initialization code:

```go
_, errAddr1 := resolverStore.CreateIfNotExists(
    context.Background(),
    "0x0000000000000000000000000000000000000000",
    1000,
)
if errAddr1 != nil {
    log.Fatalf("Failed to set initial wallet: %v", errAddr1)
}

_, errAddr2 := resolverStore.CreateIfNotExists(
    context.Background(),
    "0x0000000000000000000000000000000000000001",
    1000,
)
if errAddr2 != nil {
    log.Fatalf("Failed to set initial wallet: %v", errAddr2)
}

_, errAddr3 := resolverStore.CreateIfNotExists(
    context.Background(),
    "0x0000000000000000000000000000000000000002",
    1000,
)
if errAddr3 != nil {
    log.Fatalf("Failed to set initial wallet: %v", errAddr3)
}

---
```
